{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"rgLocation": {
			"type": "string",
			"defaultValue": "eastus"
		},
		"rgName": {
			"type": "string",
			"defaultValue": "sqliaastestrg"
		},
		"MIrgLocation": {
			"type": "string",
			"defaultValue": "eastus"
		},
		"MIrgName": {
			"type": "string",
			"defaultValue": "mitestrg"
		},
		"virtualMachineName": {
			"type": "String",
			"defaultValue": "sqlvm",
			"metadata": {
				"description": "The name of the VM"
			}
		},
		"virtualMachineSize": {
			"type": "String",
			"defaultValue": "Standard_D8s_v3",
			"metadata": {
				"description": "The virtual machine size."
			}
		},
		"existingVnetResourceGroup": {
			"type": "String",
			"defaultValue": "[parameters('rgName')]",
			"metadata": {
				"description": "Specify the resrouce group of the existing VNet"
			}
		},
		"imageOffer": {
			"type": "String",
			"defaultValue": "sql2019-ws2019",
			"allowedValues": [
				"sql2019-ws2019",
				"sql2017-ws2019",
				"SQL2017-WS2016",
				"SQL2016SP1-WS2016",
				"SQL2016SP2-WS2016",
				"SQL2014SP3-WS2012R2",
				"SQL2014SP2-WS2012R2"
			],
			"metadata": {
				"description": "Windows Server and SQL Offer"
			}
		},
		"sqlSku": {
			"type": "String",
			"defaultValue": "Standard",
			"allowedValues": [
				"Standard",
				"Enterprise",
				"SQLDEV",
				"Web",
				"Express"
			],
			"metadata": {
				"description": "SQL Server Sku"
			}
		},
		"adminUsername": {
			"type": "String",
			"defaultValue": "sqladmin",
			"metadata": {
				"description": "The admin user name of the VM"
			}
		},
		"adminPassword": {
			"type": "SecureString",
			"defaultValue": "Password12345!!",
			"metadata": {
				"description": "The admin password of the VM"
			}
		},
		"storageWorkloadType": {
			"type": "String",
			"defaultValue": "General",
			"allowedValues": [
				"General",
				"OLTP",
				"DW"
			],
			"metadata": {
				"description": "SQL Server Workload Type"
			}
		},
		"sqlDataDisksCount": {
			"type": "int",
			"defaultValue": 1,
			"minValue": 1,
			"maxValue": 8,
			"metadata": {
				"description": "Amount of data disks (1TB each) for SQL Data files"
			}
		},
		"dataPath": {
			"type": "String",
			"defaultValue": "F:\\SQLData",
			"metadata": {
				"description": "Path for SQL Data files. Please choose drive letter from F to Z, and other drives from A to E are reserved for system"
			}
		},
		"sqlLogDisksCount": {
			"type": "int",
			"defaultValue": 1,
			"minValue": 1,
			"maxValue": 8,
			"metadata": {
				"description": "Amount of data disks (1TB each) for SQL Log files"
			}
		},
		"logPath": {
			"type": "String",
			"defaultValue": "G:\\SQLLog",
			"metadata": {
				"description": "Path for SQL Log files. Please choose drive letter from F to Z and different than the one used for SQL data. Drive letter from A to E are reserved for system"
			}
		},
		"location": {
			"type": "string",
			"defaultValue": "[parameters('rgLocation')]",
			"metadata": {
				"description": "Location for all resources."
			}
		},
		"vnetName": {
			"type": "string",
			"defaultValue": "sqliaasvnet1",
			"metadata": {
				"description": "VNet name"
			}
		},
		"vnetAddressPrefix": {
			"type": "string",
			"defaultValue": "10.0.0.0/16",
			"metadata": {
				"description": "Address prefix"
			}
		},
		"subnetPrefix": {
			"type": "string",
			"defaultValue": "10.0.0.0/24",
			"metadata": {
				"description": "Subnet 1 Prefix"
			}
		},
		"subnetName": {
			"type": "string",
			"defaultValue": "sqliaassubnet1",
			"metadata": {
				"description": "Subnet 1 Name"
			}
		},
		"existingSubnetName": {
			"type": "String",
			"defaultValue": "[parameters('subnetName')]",
			"metadata": {
				"description": "Specify the name of the Subnet Name"
			}
		},
		"existingVirtualNetworkName": {
			"type": "String",
			"defaultValue": "[parameters('vnetName')]",
			"metadata": {
				"description": "Specify the name of an existing VNet in the same resource group"
			}
		},
		"MIRGName": {
			"type": "string",
			"defaultValue": "timchapmirgtest",
			"metadata": {
				"description": "Enter managed instance name."
			}
		},
		"MIInstanceName": {
			"type": "string",
			"defaultValue": "sqlmidmstest",
			"metadata": {
				"description": "Enter managed instance name."
			}
		},
		"MIadministratorLogin": {
			"type": "string",
			"defaultValue": "sqladmin",
			"metadata": {
				"description": "Enter user name."
			}
		},
		"MIadministratorLoginPassword": {
			"type": "secureString",
			"defaultValue": "ThisIsMySuperLongPassword12345!!",
			"metadata": {
				"description": "Enter password."
			}
		},
		"MIlocation": {
			"type": "string",
			"defaultValue": "eastus",
			"metadata": {
				"description": "Enter location. If you leave this field blank resource group location would be used."
			}
		},
		"MIvirtualNetworkName": {
			"type": "string",
			"defaultValue": "SQLMI-VNET",
			"metadata": {
				"description": "Enter virtual network name. If you leave this field blank name will be created by the template."
			}
		},
		"MIaddressPrefix": {
			"type": "string",
			"defaultValue": "10.0.0.0/16",
			"metadata": {
				"description": "Enter virtual network address prefix."
			}
		},
		"MIsubnetName": {
			"type": "string",
			"defaultValue": "SQLMISubnet",
			"metadata": {
				"description": "Enter subnet name."
			}
		},
		"MIsubnetPrefix": {
			"type": "string",
			"defaultValue": "10.0.0.0/24",
			"metadata": {
				"description": "Enter subnet address prefix."
			}
		},
		"MIskuName": {
			"type": "string",
			"defaultValue": "GP_Gen5",
			"allowedValues": [
				"GP_Gen5",
				"BC_Gen5"
			],
			"metadata": {
				"description": "Enter sku name."
			}
		},
		"MIvCores": {
			"type": "int",
			"defaultValue": 16,
			"allowedValues": [
				8,
				16,
				24,
				32,
				40,
				64,
				80
			],
			"metadata": {
				"description": "Enter number of vCores."
			}
		},
		"MIstorageSizeInGB": {
			"type": "int",
			"defaultValue": 256,
			"maxValue": 8192,
			"minValue": 32,
			"metadata": {
				"description": "Enter storage size."
			}
		},
		"MIlicenseType": {
			"type": "string",
			"defaultValue": "LicenseIncluded",
			"allowedValues": [
				"BasePrice",
				"LicenseIncluded"
			],
			"metadata": {
				"description": "Enter license type."
			}
		},
		"DMSserviceName": {
			"type": "string",
			"defaultValue": "IaaStoMIDMSService",
			"metadata": {
				"description": "Name of the new migration service."
			}
		},
		"DMSlocation": {
			"type": "string",
			"defaultValue": "eastus",
			"metadata": {
				"description": "Location where the resources will be deployed."
			}
		},
		"DMSvnetName": {
			"type": "string",
			"defaultValue": "DMSVNet1",
			"metadata": {
				"description": "Name of the new virtual network."
			}
		},
		"DMSsubnetName": {
			"type": "string",
			"defaultValue": "DMSSubnet1",
			"metadata": {
				"description": "Name of the new subnet associated with the virtual network."
			}
		}
	},
	"variables": {
		"uniquesuffix": "[uniqueString(subscription().subscriptionId, guid(subscription().subscriptionId))]"
	},
	"resources": [
		{
			"type": "Microsoft.Resources/resourceGroups",
			"apiVersion": "2018-05-01",
			"location": "[parameters('rgLocation')]",
			"name": "[parameters('rgName')]"
		},
		{
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2019-10-01",
			"name": "StorageAccountDeployment",
			"dependsOn": [
				"[resourceId('Microsoft.Resources/resourceGroups', parameters('rgName'))]"
			],
			"resourceGroup": "[parameters('rgName')]",
			"properties": {
				"mode": "Incremental",
				"template": {
					"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
					"contentVersion": "1.0.0.0",
					"parameters": {},
					"variables": {},
					"resources": [
						{
							"type": "Microsoft.Storage/storageAccounts",
							"apiVersion": "2021-06-01",
							"name": "[substring(toLower(concat('dmsstorageaccount', variables('uniquesuffix'))),0,22)]",
							"location": "eastus",
							"sku": {
								"name": "Standard_LRS"
							},
							"kind": "StorageV2",
							"properties": {}
						}
					]
				}
			}
		},
		{
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2019-10-01",
			"name": "IaaSNetworkDeployment",
			"dependsOn": [
				"[resourceId('Microsoft.Resources/resourceGroups', parameters('rgName'))]"
			],
			"resourceGroup": "[parameters('rgName')]",
			"properties": {
				"mode": "Incremental",
				"template": {
					"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
					"contentVersion": "1.0.0.0",
					"parameters": {},
					"variables": {},
					"resources": [
						{
							"type": "Microsoft.Network/virtualNetworks",
							"apiVersion": "2020-06-01",
							"name": "[parameters('vnetName')]",
							"location": "[parameters('location')]",
							"properties": {
								"addressSpace": {
									"addressPrefixes": [
										"[parameters('vnetAddressPrefix')]"
									]
								},
								"subnets": [
									{
										"name": "[parameters('subnetName')]",
										"properties": {
											"addressPrefix": "[parameters('subnetPrefix')]"
										}
									}
								]
							}
						}
					]
				}
			}
		},
		{
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2019-10-01",
			"name": "SQLIaaSDeploymentObjects",
			"dependsOn": [
				"[resourceId('Microsoft.Resources/resourceGroups', parameters('rgName'))]"
			],
			"resourceGroup": "[parameters('rgName')]",
			"properties": {
				"mode": "Incremental",
				"template": {
					"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
					"contentVersion": "1.0.0.0",
					"variables": {},
					"resources": [
						{
							"type": "Microsoft.Resources/deployments",
							"name": "SQLIaaSDeployment",
							"apiVersion": "2020-06-01",
							"properties": {
								"mode": "Incremental",
								"templateLink": {
									"uri": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/quickstarts/microsoft.sqlvirtualmachine/sql-vm-new-storage/azuredeploy.json"
								},
								"parameters": {
									"existingVirtualNetworkName": {
										"value": "[parameters('vnetName')]"
									},
									"existingSubnetName": {
										"value": "[parameters('subnetName')]"
									},
									"virtualMachineName": {
										"value": "[parameters('virtualMachineName')]"
									},
									"virtualMachineSize": {
										"value": "[parameters('virtualMachineSize')]"
									},
									"imageOffer": {
										"value": "[parameters('imageOffer')]"
									},
									"sqlSku": {
										"value": "[parameters('sqlSku')]"
									},
									"adminUsername": {
										"value": "[parameters('adminUsername')]"
									},
									"adminPassword": {
										"value": "[parameters('adminPassword')]"
									},
									"storageWorkloadType": {
										"value": "[parameters('storageWorkloadType')]"
									},
									"sqlDataDisksCount": {
										"value": "[parameters('sqlDataDisksCount')]"
									},
									"dataPath": {
										"value": "[parameters('dataPath')]"
									},
									"sqlLogDisksCount": {
										"value": "[parameters('sqlLogDisksCount')]"
									},
									"logPath": {
										"value": "[parameters('logPath')]"
									}
								}
							}
						}
					]
				}
			}
		},
		{
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2019-10-01",
			"name": "DMSObjects",
			"dependsOn": [
				"[resourceId('Microsoft.Resources/resourceGroups', parameters('rgName'))]"
			],
			"resourceGroup": "[parameters('rgName')]",
			"properties": {
				"mode": "Incremental",
				"template": {
					"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
					"contentVersion": "1.0.0.0",
					"variables": {},
					"resources": [
						{
							"type": "Microsoft.Resources/deployments",
							"name": "DMSServiceDeploy",
							"apiVersion": "2020-06-01",
							"properties": {
								"mode": "Incremental",
								"templateLink": {
									"uri": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/quickstarts/microsoft.datamigration/azure-database-migration-simple-deploy/azuredeploy.json"
								},
								"parameters": {
									"serviceName": {
										"value": "[parameters('DMSserviceName')]"
									},
									"location": {
										"value": "[parameters('DMSlocation')]"
									},
									"vnetName": {
										"value": "[parameters('DMSvnetName')]"
									},
									"subnetName": {
										"value": "[parameters('DMSsubnetName')]"
									}
								}
							}
						}
					]
				}
			}
		},
		{
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2019-10-01",
			"name": "MIRGObjects",
			"location": "[parameters('MIlocation')]",
			"properties": {
				"mode": "Incremental",
				"template": {
					"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
					"contentVersion": "1.0.0.0",
					"parameters": {},
					"variables": {},
					"resources": [
						{
							"type": "Microsoft.Resources/resourceGroups",
							"apiVersion": "2018-05-01",
							"location": "[parameters('MIlocation')]",
							"name": "[parameters('MIrgName')]"
						},
						{
							"type": "Microsoft.Resources/deployments",
							"name": "MIDeploy",
							"dependsOn": [
								"[resourceId('Microsoft.Resources/resourceGroups', parameters('MIrgName'))]"
							],
							"apiVersion": "2020-06-01",
							"resourceGroup": "[parameters('MIrgName')]",
							"properties": {
								"mode": "Incremental",
								"templateLink": {
									"uri": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/quickstarts/microsoft.sql/sqlmi-new-vnet/azuredeploy.json"
								},
								"parameters": {
									"managedInstanceName": {
										"value": "[concat(parameters('MIInstanceName'), '-', variables('uniquesuffix'))]"
									},
									"administratorLogin": {
										"value": "[parameters('MIadministratorLogin')]"
									},
									"administratorLoginPassword": {
										"value": "[parameters('MIadministratorLoginPassword')]"
									},
									"location": {
										"value": "[parameters('MIlocation')]"
									},
									"virtualNetworkName": {
										"value": "[parameters('MIvirtualNetworkName')]"
									},
									"addressPrefix": {
										"value": "[parameters('MIaddressPrefix')]"
									},
									"subnetName": {
										"value": "[parameters('MIsubnetName')]"
									},
									"subnetPrefix": {
										"value": "[parameters('MIsubnetPrefix')]"
									},
									"skuName": {
										"value": "[parameters('MIskuName')]"
									},
									"vCores": {
										"value": "[parameters('MIvCores')]"
									},
									"storageSizeInGB": {
										"value": "[parameters('MIstorageSizeInGB')]"
									},
									"licenseType": {
										"value": "[parameters('MIlicenseType')]"
									}
								}
							}
						}
					]
				}
			}
		}
	],
	"outputs": {}
}